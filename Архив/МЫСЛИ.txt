Деплой Prometheus+Grafana+some exporters

Задумка не хитрая, прометеус - бд временных рядов,которая сама пуллит метрики с указанных хостов.Чтобы забрать метрики, нужно чтобы кто то их отдал и самое популярное решение
для этого вопроса - экспортеры, которых имеется великое множество.Архитектура заключается в том, что экспортер устанавливается на целевую машину и занимает какой то свой дефолтный
порт, хост и порт этой конечки мы прописываем в конфиг файле прометеуса, метрики экспортех кладет по пути host:9187/metrics.

Получается что имея какую то систему, приложуху, бд, к ней на хост мы устанавливаем нужный нам экспортер, который будет собирать различные метрики, в конфиге мы указываем
адрес и порт этого экспортера и данные текут в преметеус, а уже оттуда графана их достает и визуализирует, в графане мы просто добавляем датасурс с прометеус сервером.
Под каждый экспортер есть уже готовые дашборды коммьюнити, которые весьма симпотные и юзабельные, но также мы можем составить и свой дашборд из нужных нам графиков, которые 
будут выстравиваться исходя из запроса promQL.

Прометеус сервер- установка

1.Вгетаем подходящую нам версию
2.Распаковываем 
3.Так как это не какой нибудь удобный деб пакет, то нужно ручками раскидать файлы по директориям, создать пользователя и добавить initd юнит
4.Бинарник прометеуса закидываем в /usr/local/bin
папку prometheus с конфигом закидываем в /etc/prometheus и кайфуем
4.5 chown -R prometheus:prometheus /etc/prometheus
5.Создаем initd юнит в котором мы можем указать нужные нам параметры запуска сервиса и обязательно прописываем путь к конфигу
6.как все сделали на всякий случай пишем 
systemctl daemon reload
systemctl status prometheus
systemctl start prometheus 
systemctl enable prometheus 
7.После этого прометеус должен встать, проверим его веб интерфейс


Установка node_exporter
Конечно же мы захотим следить за доступностью наших серверов + за метриками линукса, под эти цели существует node_exporter
1.Вгетаем подходящую версию 
2.ДЕФОЛТ ИНСТРУКЦИЯ ДЕПЛОЯ ЭКСПОРТЕРА
	1.Логика весьма простая- бинарник в /usr/local/bin
	2.Создаем юнит initd чтобы у нас был сервис с этим экспортером 
	3.нетстатом проверяем на каком порту он висит и добавляем его в конфиг прометеуса, и с ходу ищем готовый дашборд в графане под него.В конфиге мы можем прописывать 
	labels(ярлыки) под эту джобу.
	
	Траблшутинг:1.Если что то не заработало сразу, проверяем статус сервиса, нетстатом порт, переходим в веб интерфейс экспортера(дада, они часто там есть), 
потом уходим на /metrics.Если на стороне экспортера все ок, то значит смотрим конфиг, может накосячили в ямлике.

Установка PostresQL + postrgres_exporter
Какой бы простой не казалось установка постгреса, не забываем что для элементарной работы + обеспечения элементарного секурити нам нужно 
1.Создать отдельного пользователя и дать ему нужные привелегии GRANT ALL PRIVELEGES
2.Сделать изменения в двух конфиг файлах, в основном - добавить добавить чтобы psql server принимал запросы со всех хостов, а не только с локалхоста, ставим звездочку в нужном 
параметре, который мы раскомментим.Подозреваю что там можно указать и диапазон адресов или же несколько статик адресов С ЭТОГО МОМЕНТА СУБД ПРИНИМАЕТ ЗАПРОСЫ СО ВСЕХ ХОСТОВ
Сделав это, переходим в другой конфиг файл, где мы уже прописываем к нужному нам хосту нужного пользователя для подключения, но обычно мы просто указываем также(создаем правило)
суть которого в разрешении подключаться со всех хостов под любыми пользователями(лиж бы пароль был верный).Да, для нормальной секурити тут нужна другая конфигурация, но мы сейчас
не об этом.Сделав это, рестартаем сервис с БД.
Траблшутинг:делаем нетстат, если порт бд не слушает, то что то не так в конфиге и она просто не запустилась.Если слушает но не дает, то также смотрим конфиг.

После того как БД встала и мы можем к ней подключиться(проверьте подключение и на локалхост и с другой тачки), мы можем смело накатывать экспортер.
Экспортер устанавливаем по дефолтной инструкции ничего хитрого, в гитхабе только нужно найти не контейнер, а бинарник. С контейнерами разберемся потом, бинарники обычно висят в 
гите в /releases 
Дальше также втыкаем готовый дашборд коммьюнити и наслаждаемся графиками, также для хорошей картинки можем сделать небольшой втроенный в PG стресс тест 

Установка Grafana
Можем скачать не самую ласт версию через apt(удобно), можем вгетнуть деб пакет и тоже удобно его установить.Думаю за это графана получила свою популярность

